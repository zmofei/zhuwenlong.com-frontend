ROSTemplateFormatVersion: '2015-09-01'
Transform: 'Aliyun::Serverless-2018-04-03'
Resources:
  zhuwenlong_com_frontend:
    Type: 'Aliyun::Serverless::Service'
    Properties:
      Description: This is FC service
      NasConfig:
        UserId: 10003
        GroupId: 10003
        MountPoints:
          - ServerAddr:
              'Fn::Join':
                - ''
                - - Ref: MountTarget
                  - ':/'
                  - zhuwenlong_com_frontend
            MountDir: /mnt/auto
      VpcConfig:
        VpcId:
          Ref: Vpc
        VSwitchIds:
          - Ref: VSwitch
        SecurityGroupId:
          Ref: SecurityGroup
    zhuwenlong_com_frontend:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: index.handler
        Runtime: custom
        CodeUri: >-
          oss://fun-gen-cn-hangzhou-1537222982405252/27d598e75422f22b3f08ad8cf807a653
        MemorySize: 1024
        InstanceConcurrency: 5
        Timeout: 120
        EnvironmentVariables:
          NODE_PATH: '/mnt/auto/node_modules:/usr/local/lib/node_modules'
      Events:
        httpTrigger:
          Type: HTTP
          Properties:
            AuthType: ANONYMOUS
            Methods:
              - GET
              - POST
              - PUT
  Domain:
    Type: 'Aliyun::Serverless::CustomDomain'
    Properties:
      DomainName: Auto
      Protocol: HTTP
      RouteConfig:
        Routes:
          /*:
            ServiceName:
              'Fn::GetAtt':
                - zhuwenlong_com_frontend
                - ServiceName
            FunctionName:
              'Fn::GetAtt':
                - zhuwenlong_com_frontendzhuwenlong_com_frontend
                - FunctionName
  zhuwenlong_com_frontend-NasCpInvoker:
    Type: 'ALIYUN::FC::FunctionInvoker'
    DependsOn: MountTarget
    Properties:
      FunctionName:
        'Fn::GetAtt':
          - NasNasCpFunc
          - FunctionName
      ServiceName:
        'Fn::GetAtt':
          - Nas
          - ServiceName
      Event:
        'Fn::Join':
          - ''
          - - '{"dst": "/mnt/nas_dependencies/'
            - zhuwenlong_com_frontend
            - '", "bucket": "'
            - fun-gen-cn-hangzhou-1537222982405252
            - >-
              ", "objectNames": ["bca18ce3934776a1b7c5bb6956c9d79f"], "rosCurl":
              "
            - 'Fn::GetAtt':
                - WaitConHandle
                - CurlCli
            - '"}'
      Async: true
      ExecuteVersion: 1
  Vpc:
    Type: 'ALIYUN::ECS::VPC'
    Properties:
      Description: used for FC Application Repository
      CidrBlock: 10.0.0.0/8
      VpcName:
        Ref: 'ALIYUN::StackName'
  SecurityGroup:
    Type: 'ALIYUN::ECS::SecurityGroup'
    DependsOn:
      - AliyunECSNetworkInterfaceManagementAccesszhuwenlong_com_frontendRole
      - AliyunECSNetworkInterfaceManagementAccessNasRole
    Properties:
      SecurityGroupName:
        Ref: 'ALIYUN::StackName'
      VpcId:
        Ref: Vpc
  VSwitch:
    Type: 'ALIYUN::ECS::VSwitch'
    Properties:
      ZoneId:
        'Fn::FindInMap':
          - RegionMap
          - Ref: 'ALIYUN::Region'
          - ZoneId
      VpcId:
        Ref: Vpc
      CidrBlock: 10.20.0.0/16
  FileSystem:
    Type: 'ALIYUN::NAS::FileSystem'
    Properties:
      StorageType: Performance
      Description: used_for_fun
      ProtocolType: NFS
  MountTarget:
    Type: 'ALIYUN::NAS::MountTarget'
    Properties:
      Status: Active
      VpcId:
        Ref: Vpc
      NetworkType: Vpc
      VSwitchId:
        Ref: VSwitch
      AccessGroupName: DEFAULT_VPC_GROUP_NAME
      FileSystemId:
        Ref: FileSystem
  Nas:
    Type: 'Aliyun::Serverless::Service'
    Properties:
      Description: download dependences from oss and upload to nas.
      Policies:
        - AliyunOssFullAccess
      VpcConfig:
        VpcId:
          Ref: Vpc
        VSwitchIds:
          - Ref: VSwitch
        SecurityGroupId:
          Ref: SecurityGroup
      NasConfig:
        UserId: 10003
        GroupId: 10003
        MountPoints:
          - ServerAddr:
              'Fn::Join':
                - ''
                - - Ref: MountTarget
                  - ':/'
            MountDir: /mnt/nas_dependencies
    NasCpFunc:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: index.cpFromOssToNasHandler
        Runtime: nodejs8
        CodeUri: >-
          oss://fun-gen-cn-hangzhou-1537222982405252/8fd09e940aaa3a07d09816199151f196
        MemorySize: 3072
        Timeout: 300
  WaitCondition:
    Type: 'ALIYUN::ROS::WaitCondition'
    Properties:
      Count: 1
      Handle:
        Ref: WaitConHandle
      Timeout: 600
    DependsOn: Nas
  WaitConHandle:
    Type: 'ALIYUN::ROS::WaitConditionHandle'
    Properties:
      Mode: Full
      Count: -1
Outputs:
  zhuwenlong_com_frontend-Event:
    Description: function invoke event
    Value:
      'Fn::Join':
        - ''
        - - '{"dst": "/mnt/nas_dependencies/'
          - zhuwenlong_com_frontend
          - '", "bucket": "'
          - fun-gen-cn-hangzhou-1537222982405252
          - '", "objectNames": ["bca18ce3934776a1b7c5bb6956c9d79f"], "rosCurl": "'
          - 'Fn::GetAtt':
              - WaitConHandle
              - CurlCli
          - '"}'
  CurlCli:
    Value:
      'Fn::GetAtt':
        - WaitConHandle
        - CurlCli
  Data:
    Value:
      'Fn::GetAtt':
        - WaitCondition
        - Data
  ErrorData:
    Value:
      'Fn::GetAtt':
        - WaitCondition
        - ErrorData
Mappings:
  RegionMap:
    cn-shanghai:
      ZoneId: cn-shanghai-e
    cn-hangzhou:
      ZoneId: cn-hangzhou-g
    cn-qingdao:
      ZoneId: cn-qingdao-c
    cn-beijing:
      ZoneId: cn-beijing-c
    cn-zhangjiakou:
      ZoneId: cn-zhangjiakou-b
    cn-huhehaote:
      ZoneId: cn-huhehaote-a
    cn-shenzhen:
      ZoneId: cn-shenzhen-d
    cn-hongkong:
      ZoneId: cn-hongkong-c
    ap-southeast-1:
      ZoneId: ap-southeast-1a
    ap-southeast-2:
      ZoneId: ap-southeast-2a
    ap-southeast-5:
      ZoneId: ap-southeast-5a
    ap-northeast-1:
      ZoneId: ap-northeast-1a
    eu-central-a:
      ZoneId: eu-central-a
    us-west-1:
      ZoneId: us-west-1a
    us-east-1:
      ZoneId: us-east-1a
    ap-south-1:
      ZoneId: ap-south-1a
